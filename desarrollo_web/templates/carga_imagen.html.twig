<!DOCTYPE html>
<html>
<head>
    <title>Cargar Imagen ELISA</title>
    <style>
        canvas {
            border: 2px solid black;
            display: block;
            margin: 20px auto;
        }
        #output {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Cargar Imagen ELISA</h1>

    <!-- Formulario para subir la imagen -->
    <form id="imageForm" action="{{ path('app_procesar_imagen') }}" method="POST" enctype="multipart/form-data">
        <label for="photo">Selecciona una imagen:</label>
        <input type="file" id="photo" name="photo" accept="image/*" required>
        <br><br>
        
        <!-- Aquí se añaden los inputs ocultos para las coordenadas -->
        <input type="hidden" id="startX" name="startX">
        <input type="hidden" id="startY" name="startY">
        <input type="hidden" id="endX" name="endX">
        <input type="hidden" id="endY" name="endY">

        <button type="submit">Subir y Procesar Imagen</button>
    </form>

    <!-- Canvas donde se mostrará la imagen y se permitirá seleccionar una región -->
    <canvas id="imageCanvas"></canvas>

    <!-- Área para mostrar las coordenadas seleccionadas -->
    <div id="output"></div>

    <script>

        document.getElementById('imageForm').addEventListener('submit', function(event) {
            const startX = document.getElementById('startX').value;
            const startY = document.getElementById('startY').value;
            const endX = document.getElementById('endX').value;
            const endY = document.getElementById('endY').value;
            
            // Verificar si las coordenadas están definidas
            console.log('startX:', startX, 'startY:', startY, 'endX:', endX, 'endY:', endY);
        
            if (!startX || !startY || !endX || !endY) {
                alert('Las coordenadas no están definidas.');
                event.preventDefault(); // Prevenir envío del formulario si no están definidas
            }
        });

        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const imageLoader = document.getElementById('photo');
        let startX, startY, endX, endY, isDragging = false;
        let img = new Image(); // Imagen cargada

        // Al cargar una imagen, se dibuja en el canvas
        imageLoader.addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        // Iniciar la selección de área (mousedown)
        canvas.addEventListener('mousedown', (e) => {
            startX = e.offsetX;
            startY = e.offsetY;
            isDragging = true;
        });

        // Dibujar el rectángulo mientras arrastras el mouse
        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                endX = e.offsetX;
                endY = e.offsetY;
                drawSelection(); // Dibujar la selección en tiempo real
            }
        });

        // Finalizar la selección de área (mouseup)
        canvas.addEventListener('mouseup', () => {
            isDragging = false;

            // Actualizar los inputs ocultos con las coordenadas seleccionadas
            document.getElementById('startX').value = startX;
            document.getElementById('startY').value = startY;
            document.getElementById('endX').value = endX;
            document.getElementById('endY').value = endY;

            // Mostrar las coordenadas seleccionadas
            document.getElementById('output').textContent = `Área Seleccionada: 
                Arriba Izquierda (${startX}, ${startY}), Abajo Derecha (${endX}, ${endY})`;
        });

        // Función para dibujar el área seleccionada
        function drawSelection() {
            // Limpiar el canvas y volver a dibujar la imagen
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);

            // Dibujar el rectángulo mientras se arrastra el mouse
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY, endX - startX, endY - startY);
        }
    </script>
</body>
</html>
